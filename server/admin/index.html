<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timi 管理后台</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
.login-wrap { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
.login-box { background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,.08); width: 360px; }
.login-box h2 { text-align: center; margin-bottom: 24px; font-size: 22px; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-size: 14px; color: #666; }
.form-group input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; transition: border .2s; }
.form-group input:focus { border-color: #4a90d9; }
.btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; transition: opacity .2s; }
.btn-primary { background: #4a90d9; color: #fff; width: 100%; }
.btn-primary:hover { opacity: .9; }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-danger { background: #e74c3c; color: #fff; }
.btn-danger:hover { opacity: .9; }
.btn-success { background: #27ae60; color: #fff; }
.btn-success:hover { opacity: .9; }
.btn-warning { background: #f39c12; color: #fff; }
.btn-warning:hover { opacity: .9; }
.btn-outline { background: transparent; border: 1px solid #ddd; color: #666; }
.btn-outline:hover { border-color: #4a90d9; color: #4a90d9; }
.error-msg { color: #e74c3c; font-size: 13px; margin-top: 8px; text-align: center; }

/* 主布局 */
.app { display: none; }
.app.active { display: flex; min-height: 100vh; }
.sidebar { width: 220px; background: #2c3e50; color: #fff; padding: 20px 0; flex-shrink: 0; }
.sidebar h3 { padding: 0 20px 20px; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,.1); }
.sidebar .nav-item { padding: 12px 20px; cursor: pointer; transition: background .2s; font-size: 14px; }
.sidebar .nav-item:hover, .sidebar .nav-item.active { background: rgba(255,255,255,.1); }
.sidebar .nav-logout { position: absolute; bottom: 20px; padding: 12px 20px; cursor: pointer; color: #e74c3c; font-size: 14px; }
.main { flex: 1; padding: 24px; overflow-y: auto; }
.main h2 { margin-bottom: 20px; font-size: 20px; }

/* 统计卡片 */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
.stat-card .label { font-size: 13px; color: #999; margin-bottom: 8px; }
.stat-card .value { font-size: 28px; font-weight: 700; color: #2c3e50; }

/* 表格 */
.table-wrap { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.05); overflow: hidden; }
.table-toolbar { padding: 16px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #eee; }
.table-toolbar input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; width: 240px; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px 16px; text-align: left; font-size: 14px; }
th { background: #f8f9fa; color: #666; font-weight: 600; }
tr:not(:last-child) td { border-bottom: 1px solid #f0f0f0; }
.badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; }
.badge-active { background: #e8f5e9; color: #27ae60; }
.badge-banned { background: #fde8e8; color: #e74c3c; }
.badge-used { background: #fde8e8; color: #e74c3c; }
.badge-unused { background: #e8f5e9; color: #27ae60; }
.pagination { padding: 16px; display: flex; justify-content: center; gap: 8px; }
.pagination button { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
.pagination button.active { background: #4a90d9; color: #fff; border-color: #4a90d9; }
.pagination button:disabled { opacity: .5; cursor: not-allowed; }

/* 模态框 */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 100; justify-content: center; align-items: center; }
.modal-overlay.active { display: flex; }
.modal { background: #fff; border-radius: 12px; padding: 24px; width: 400px; max-width: 90vw; }
.modal h3 { margin-bottom: 16px; }
.modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

/* 页面切换 */
.page { display: none; }
.page.active { display: block; }
</style>
</head>
<body>

<!-- 登录页 -->
<div class="login-wrap" id="login-page">
  <div class="login-box">
    <h2>Timi 管理后台</h2>
    <div class="form-group">
      <label>用户名</label>
      <input type="text" id="login-username" placeholder="管理员用户名">
    </div>
    <div class="form-group">
      <label>密码</label>
      <input type="password" id="login-password" placeholder="密码" onkeydown="if(event.key==='Enter')adminLogin()">
    </div>
    <button class="btn btn-primary" onclick="adminLogin()">登录</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- 主应用 -->
<div class="app" id="app">
  <div class="sidebar">
    <h3>Timi 管理</h3>
    <div class="nav-item active" onclick="switchPage('dashboard')">统计面板</div>
    <div class="nav-item" onclick="switchPage('users')">用户管理</div>
    <div class="nav-item" onclick="switchPage('codes')">邀请码管理</div>
    <div class="nav-item" style="position:fixed;bottom:20px;color:#e74c3c" onclick="adminLogout()">退出登录</div>
  </div>
  <div class="main">
    <!-- 统计面板 -->
    <div class="page active" id="page-dashboard">
      <h2>统计面板</h2>
      <div class="stats-grid" id="stats-grid"></div>
    </div>

    <!-- 用户管理 -->
    <div class="page" id="page-users">
      <h2>用户管理</h2>
      <div class="table-wrap">
        <div class="table-toolbar">
          <input type="text" id="user-search" placeholder="搜索用户名..." oninput="debounce(loadUsers, 300)()">
        </div>
        <table><thead><tr>
          <th>用户名</th><th>角色</th><th>状态</th><th>邀请码</th><th>注册时间</th><th>操作</th>
        </tr></thead><tbody id="users-tbody"></tbody></table>
        <div class="pagination" id="users-pagination"></div>
      </div>
    </div>

    <!-- 邀请码管理 -->
    <div class="page" id="page-codes">
      <h2>邀请码管理</h2>
      <div style="margin-bottom:16px;display:flex;gap:12px;align-items:center">
        <input type="number" id="code-count" value="5" min="1" max="100" style="width:80px;padding:8px;border:1px solid #ddd;border-radius:6px">
        <button class="btn btn-success btn-sm" onclick="generateCodes()">批量生成</button>
      </div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>邀请码</th><th>状态</th><th>使用者</th><th>创建时间</th><th>操作</th>
        </tr></thead><tbody id="codes-tbody"></tbody></table>
        <div class="pagination" id="codes-pagination"></div>
      </div>
    </div>
  </div>
</div>

<!-- 重置密码模态框 -->
<div class="modal-overlay" id="modal-reset">
  <div class="modal">
    <h3>重置密码</h3>
    <div class="form-group">
      <label>新密码</label>
      <input type="password" id="reset-password-input" placeholder="至少6个字符">
    </div>
    <div class="actions">
      <button class="btn btn-outline btn-sm" onclick="closeModal('modal-reset')">取消</button>
      <button class="btn btn-primary btn-sm" onclick="confirmResetPassword()">确认</button>
    </div>
  </div>
</div>
</body>
<script>
const API = location.origin;
let token = localStorage.getItem('admin_token');
let currentPage = 'dashboard';
let usersPage = 1, codesPage = 1;
let resetUserId = null;

// 工具函数
function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
function fmt(d) { return new Date(d).toLocaleString('zh-CN'); }

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(API + path, { ...opts, headers });
  if (res.status === 401) { adminLogout(); throw new Error('未授权'); }
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || '请求失败');
  return data;
}

// 登录
async function adminLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  try {
    const data = await fetch(API + '/api/auth/login', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    }).then(r => r.json());
    if (data.error) { errEl.textContent = data.error; return; }
    if (data.user.role !== 'admin') { errEl.textContent = '需要管理员权限'; return; }
    token = data.token;
    localStorage.setItem('admin_token', token);
    showApp();
  } catch (e) { errEl.textContent = '登录失败'; }
}

function adminLogout() {
  token = null;
  localStorage.removeItem('admin_token');
  document.getElementById('app').classList.remove('active');
  document.getElementById('login-page').style.display = 'flex';
}

async function showApp() {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('app').classList.add('active');
  loadStats();
  loadUsers();
  loadCodes();
}

function switchPage(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', ['dashboard','users','codes'][i] === page));
}

// 统计
async function loadStats() {
  try {
    const s = await api('/api/admin/stats');
    document.getElementById('stats-grid').innerHTML = [
      ['注册用户', s.totalUsers], ['活跃用户', s.activeUsers], ['封禁用户', s.bannedUsers],
      ['今日注册', s.todayRegistered], ['邀请码总数', s.totalCodes], ['已使用', s.usedCodes]
    ].map(([l, v]) => `<div class="stat-card"><div class="label">${l}</div><div class="value">${v}</div></div>`).join('');
  } catch (e) { console.error(e); }
}

// 用户管理
async function loadUsers() {
  try {
    const search = document.getElementById('user-search')?.value || '';
    const data = await api(`/api/admin/users?page=${usersPage}&limit=20&search=${encodeURIComponent(search)}`);
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = data.users.map(u => `<tr>
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td><span class="badge badge-${u.status}">${u.status === 'active' ? '正常' : '封禁'}</span></td>
      <td>${u.inviteCode?.code || '-'}</td>
      <td>${fmt(u.createdAt)}</td>
      <td>${u.role !== 'admin' ? `
        <button class="btn btn-sm ${u.status === 'banned' ? 'btn-success' : 'btn-warning'}" onclick="toggleBan('${u.id}')">${u.status === 'banned' ? '解封' : '封禁'}</button>
        <button class="btn btn-sm btn-outline" onclick="openResetPassword('${u.id}')">重置密码</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}','${u.username}')">删除</button>
      ` : '<span style="color:#999">管理员</span>'}</td>
    </tr>`).join('');
    renderPagination('users-pagination', data.page, data.totalPages, p => { usersPage = p; loadUsers(); });
  } catch (e) { console.error(e); }
}

async function toggleBan(id) {
  try { await api(`/api/admin/users/${id}/ban`, { method: 'PATCH' }); loadUsers(); loadStats(); } catch (e) { alert(e.message); }
}

function openResetPassword(id) {
  resetUserId = id;
  document.getElementById('reset-password-input').value = '';
  document.getElementById('modal-reset').classList.add('active');
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }

async function confirmResetPassword() {
  const pw = document.getElementById('reset-password-input').value;
  if (pw.length < 6) { alert('密码至少6个字符'); return; }
  try {
    await api(`/api/admin/users/${resetUserId}/reset-password`, { method: 'PATCH', body: JSON.stringify({ newPassword: pw }) });
    closeModal('modal-reset');
    alert('密码已重置');
  } catch (e) { alert(e.message); }
}

async function deleteUser(id, name) {
  if (!confirm(`确定删除用户 "${name}" 及其所有数据？`)) return;
  try { await api(`/api/admin/users/${id}`, { method: 'DELETE' }); loadUsers(); loadStats(); } catch (e) { alert(e.message); }
}

// 邀请码管理
async function loadCodes() {
  try {
    const data = await api(`/api/admin/invite-codes?page=${codesPage}&limit=20`);
    const tbody = document.getElementById('codes-tbody');
    tbody.innerHTML = data.codes.map(c => `<tr>
      <td style="font-family:monospace;font-size:15px;letter-spacing:1px">${c.code}</td>
      <td><span class="badge badge-${c.used ? 'used' : 'unused'}">${c.used ? '已使用' : '未使用'}</span></td>
      <td>${c.usedBy?.username || '-'}</td>
      <td>${fmt(c.createdAt)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteCode('${c.id}')">删除</button></td>
    </tr>`).join('');
    renderPagination('codes-pagination', data.page, data.totalPages, p => { codesPage = p; loadCodes(); });
  } catch (e) { console.error(e); }
}

async function generateCodes() {
  const count = parseInt(document.getElementById('code-count').value) || 5;
  try { await api('/api/admin/invite-codes', { method: 'POST', body: JSON.stringify({ count }) }); loadCodes(); loadStats(); } catch (e) { alert(e.message); }
}

async function deleteCode(id) {
  if (!confirm('确定删除此邀请码？')) return;
  try { await api(`/api/admin/invite-codes/${id}`, { method: 'DELETE' }); loadCodes(); } catch (e) { alert(e.message); }
}

function renderPagination(elId, current, total, cb) {
  const el = document.getElementById(elId);
  if (total <= 1) { el.innerHTML = ''; return; }
  let html = `<button ${current <= 1 ? 'disabled' : ''} onclick="void 0">上一页</button>`;
  for (let i = 1; i <= total; i++) html += `<button class="${i === current ? 'active' : ''}">${i}</button>`;
  html += `<button ${current >= total ? 'disabled' : ''}>下一页</button>`;
  el.innerHTML = html;
  el.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
      const text = btn.textContent;
      if (text === '上一页') cb(current - 1);
      else if (text === '下一页') cb(current + 1);
      else cb(parseInt(text));
    });
  });
}

// 初始化：检查是否已登录
(async () => {
  if (token) {
    try { const me = await api('/api/auth/me'); if (me.role === 'admin') { showApp(); return; } } catch (e) {}
    adminLogout();
  }
})();
</script>
</html>
